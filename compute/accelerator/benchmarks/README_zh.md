# README - 中文翻译

# 加速器基准测试

## 最大可实现矩阵乘法浮点运算次数查找器

最大可实现矩阵乘法浮点运算次数（MAMF）基准测试：[mamf-finder.py](./mamf-finder.py)

有关各种加速器的详细讨论和数据，请参阅[最大可实现浮点运算次数](../#maximum-achievable-flops)。

虽然一些加速器制造商发布了理论TFLOPS，但这些通常无法达到。因此，在我们尝试优化软件时，没有一个实际的性能标准可以用来比较。模型浮点运算利用率（MFU）指标衡量实际TFLOPS与理论TFLOPS的比例。通常，当得分接近50%的MFU时，就被认为是一个胜利。但这并不能告诉我们距离真正的可实现吞吐量还有多远。

该基准测试扫描各种大型矩阵乘法形状，并报告其记录到的最高可实现TFLOPS。由于转换器训练和部分推理工作负载主要由大型矩阵乘法操作主导，因此可以安全地使用每个加速器上能测量到的最佳矩阵乘法TFLOPS作为粗略估计，即最大可实现矩阵乘法浮点运算次数（MAMF）。现在，我们可以使用模型可实现矩阵乘法浮点运算利用率（MAMFU），而不是以前使用的MFU。

因此，现在你可以将你的训练或推理所测量到的TFLOPS与一个实际的数字进行比较。由于你现在更接近100%，因此更容易知道何时停止优化。

目前支持的高端架构：
- NVIDIA：V100、A100、H100等
- AMD：MI250、MI300X等
- 英特尔Gaudi2+

公平性说明：
- 如果你能找到一种更好且更高效的方法来检测每个新加速器的最佳矩阵乘法TFLOPS，方法是将其视为黑盒，请发送包含生成的日志文件的PR。
- 如果你知道该基准测试应在特殊条件下运行以显示最佳结果，例如某些内核设置或类似设置，请提交PR添加此类特殊说明。例如，有人告诉我，对于AMD MI300X来说，禁用numa_balancing可能会有所帮助。

### 架构特定说明：

在运行基准测试之前，请遵循特殊的设置说明以获得最佳结果：

**MI300x**：

关闭numa_balancing以提高性能：
```sh
sudo sh -c 'echo 0 > /proc/sys/kernel/numa_balancing'
```

### 使用示例

在下面的范围中，`N` 是降维维度，使得 `(MxN)*(NxK)=(MxK)`，我们会打印出最佳测量TFLOPS对应的MxNxK形状。

默认情况下，我们对每个形状使用50次预热迭代和100次测量迭代，然后选择最快的结果（而不是平均值）。你可以通过参数 `--num_warmup_iterations` 和 `--num_iterations` 分别更改迭代次数。

你可以通过 `--dtype` 参数指定数据类型，它必须是有效的 `torch` 数据类型之一——例如，`float16`、`bfloat16`、`float32` 等。如果没有指定，则使用 `bfloat16`。

这里我们执行 `torch.mm(MxN,NxK) -> MxK`

1. 快速运行（不到1分钟）——应该能达到最大可实现结果的80-90%左右——适合快速尝试，但不足以得到高精度测量。

```sh
./mamf-finder.py --m_range 0 20480 256 --n 4096 --k 4096 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

2. 更全面的搜索（会花费更长时间）——但你可以按Ctrl+C停止并获取当前最佳结果：

```sh
./mamf-finder.py --m_range 0 5376 256 --n_range 0 5376 256 --k_range 0 5376 256 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

3. 非常长的全面搜索（可能需要数天时间）——但你可以按Ctrl+C停止并获取当前最佳结果：

```sh
./mamf-finder.py --m_range 0 20480 256 --n_range 0 20480 256 --k_range 0 20480 256 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

4. 如果你想测量特定的形状，比如你的训练所使用的形状，使用具体的形状，而不是范围，比如说要测量 1024x1024x1024，你可以运行：

```sh
./mamf-finder.py --m 1024 --n 1024 --k 1024 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

5. 不同加速器有不同的形状范围，可以获得最佳TFLOPS，因此很难建议一个适用于所有加速器的范围——以下是一些基于实验和贡献者建议的建议：

- **A100** + **MI300X**

```sh
./mamf-finder.py --m_range 0 5376 256 --n_range 0 5376 256 --k_range 0 5376 256 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

- **H100**

```sh
./mamf-finder.py --m_range 0 20480 256 --n_range 0 20480 256 --k_range 0 20480 256 --output_file=$(date +"%Y-%m-%d-%H:%M:%S").txt
```

要更好地了解哪种形状为特定加速器提供了最高的矩阵乘法浮点运算次数，请参阅[向量和矩阵大小可整除性](../../../training/performance/README.md#vector-and-matrix-size-divisibility)。